# å‘Šåˆ«å¡é¡¿å’Œè€—ç”µï¼view_model çš„ Pause æœºåˆ¶å¦‚ä½•æ‹¯æ•‘ä½ çš„ Flutter åº”ç”¨

## ä¸€ã€èƒŒæ™¯ï¼šä¸ºä»€ä¹ˆéœ€è¦ Pause æœºåˆ¶ï¼Ÿ

åœ¨å¼€å‘ Flutter åº”ç”¨æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ä¸€äº›åœºæ™¯ï¼Œé¡µé¢è™½ç„¶å­˜åœ¨äºå†…å­˜ä¸­ï¼Œä½†å¯¹ç”¨æˆ·å¹¶ä¸å¯è§ã€‚ä¾‹å¦‚ï¼š

1.  **è¢«æ–°é¡µé¢è¦†ç›–**ï¼šç”¨æˆ·ä»é¡µé¢ A è·³è½¬åˆ°é¡µé¢ Bï¼Œæ­¤æ—¶é¡µé¢ A ä»ç„¶åœ¨è·¯ç”±æ ˆä¸­ï¼Œä½†è¢« B è¦†ç›–ã€‚
2.  **åœ¨ TabBarView ç­‰åœºæ™¯ä¸­**ï¼šå½“ä½¿ç”¨ `TabBarView` æˆ– `PageView` æ—¶ï¼Œåªæœ‰å½“å‰é¡µé¢æ˜¯å¯è§çš„ã€‚è¿™æ˜¯ä¸€ä¸ªéœ€è¦å¼€å‘è€…æ‰‹åŠ¨ç®¡ç†ï¼Œä»¥æš‚åœåå°é¡µé¢æ´»åŠ¨çš„å…¸å‹åœºæ™¯ã€‚
3.  **åº”ç”¨åˆ‡æ¢åˆ°åå°**ï¼šç”¨æˆ·æŒ‰ä¸‹ Home é”®æˆ–åˆ‡æ¢åˆ°å…¶ä»– Appï¼Œæ•´ä¸ª Flutter åº”ç”¨è¿›å…¥åå°ã€‚

åœ¨è¿™äº›â€œä¸å¯è§â€çš„çŠ¶æ€ä¸‹ï¼Œå¦‚æœé¡µé¢å…³è”çš„ `ViewModel` ä»åœ¨æ‰§è¡Œè€—æ—¶æ“ä½œï¼ˆå¦‚ç½‘ç»œè½®è¯¢ã€æ•°æ®è®¡ç®—ï¼‰å¹¶é€šè¿‡ `notifyListeners()` é¢‘ç¹è§¦å‘ `setState()`ï¼Œå°±ä¼šå¯¼è‡´ä¸€ç³»åˆ—é—®é¢˜ï¼š

-   **æ€§èƒ½æµªè´¹**ï¼šUI é‡å»ºæ˜¯æ˜‚è´µçš„ï¼Œå¯¹ä¸€ä¸ªçœ‹ä¸è§çš„ Widget è¿›è¡Œé‡å»ºï¼Œçº¯å±æµªè´¹ CPU å’Œ GPU èµ„æºã€‚
-   **ç”µé‡æ¶ˆè€—**ï¼šä¸å¿…è¦çš„è®¡ç®—å’Œæ¸²æŸ“ä¼šåŠ é€Ÿç”µé‡æ¶ˆè€—ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚
-   **æ½œåœ¨çš„ Bug**ï¼šåœ¨é¡µé¢ä¸å¯è§æ—¶æ›´æ–° UIï¼Œå¯èƒ½ä¼šå¼•å‘æ„æƒ³ä¸åˆ°çš„çŠ¶æ€é”™è¯¯ã€‚

**æ ¸å¿ƒç—›ç‚¹**ï¼šæˆ‘ä»¬éœ€è¦ä¸€ç§æœºåˆ¶ï¼Œèƒ½å¤Ÿæ™ºèƒ½åœ°è¯†åˆ«é¡µé¢æ˜¯å¦å¯è§ï¼Œå¹¶åœ¨é¡µé¢ä¸å¯è§æ—¶â€œæš‚åœâ€ `ViewModel` çš„åˆ·æ–°ï¼Œåœ¨é¡µé¢æ¢å¤å¯è§æ—¶å†â€œæ¢å¤â€å¹¶åŒæ­¥æœ€æ–°çš„çŠ¶æ€ã€‚è¿™å°±æ˜¯ `view_model` åŒ…ä¸­ `Pause` æœºåˆ¶çš„è®¾è®¡åˆè¡·ã€‚

---

## äºŒã€å¦‚ä½•ç›‘æ§é¡µé¢çš„â€œä¸å¯è§â€çŠ¶æ€ï¼Ÿ

ä¸ºäº†å®ç°æ™ºèƒ½æš‚åœï¼Œé¦–å…ˆè¦èƒ½å‡†ç¡®åœ°ç›‘æ§åˆ°é¡µé¢çš„å¯è§æ€§å˜åŒ–ã€‚Flutter æä¾›äº†å¤šç§æœºåˆ¶æ¥æ•æ‰è¿™äº›å˜åŒ–ï¼Œ`view_model` å°†å®ƒä»¬å°è£…æˆäº†ä¸åŒçš„ `ViewModelBindingPauseProvider`ã€‚

### 1. è·¯ç”±äº‹ä»¶ (`PageRoutePauseProvider`)

é€šè¿‡ `RouteObserver` å’Œ `RouteAware`ï¼Œæˆ‘ä»¬å¯ä»¥ç›‘å¬è·¯ç”±çš„æ¨å…¥ï¼ˆpushï¼‰å’Œå¼¹å‡ºï¼ˆpopï¼‰äº‹ä»¶ã€‚

-   **`didPushNext()`**ï¼šå½“ä¸€ä¸ªæ–°è·¯ç”±è¢«æ¨åˆ°å½“å‰è·¯ç”±ä¹‹ä¸Šæ—¶è§¦å‘ã€‚è¿™æ„å‘³ç€å½“å‰é¡µé¢è¢«è¦†ç›–äº†ï¼Œåº”è¯¥**æš‚åœ**ã€‚
-   **`didPopNext()`**ï¼šå½“é¡¶å±‚è·¯ç”±è¢«å¼¹å‡ºï¼Œä½¿å½“å‰è·¯ç”±é‡æ–°å¯è§æ—¶è§¦å‘ã€‚è¿™æ„å‘³ç€å½“å‰é¡µé¢æ¢å¤å¯è§ï¼Œåº”è¯¥**æ¢å¤**ã€‚

`PageRoutePauseProvider` å°±æ˜¯åŸºäºè¿™ä¸ªåŸç†ï¼Œåœ¨é¡µé¢è¢«è¦†ç›–æ—¶å‘å‡ºæš‚åœä¿¡å·ã€‚

### 2. åº”ç”¨ç”Ÿå‘½å‘¨æœŸ (`AppPauseProvider`)

é€šè¿‡ `WidgetsBindingObserver`ï¼Œæˆ‘ä»¬å¯ä»¥ç›‘å¬æ•´ä¸ªåº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ã€‚

-   **`AppLifecycleState.hidden`** (æˆ– `paused`, `inactive`)ï¼šå½“åº”ç”¨åˆ‡æ¢åˆ°åå°æˆ–è¢«ç”µè¯ç­‰ç³»ç»Ÿäº‹ä»¶ä¸­æ–­æ—¶è§¦å‘ã€‚æ­¤æ—¶æ•´ä¸ªåº”ç”¨éƒ½ä¸å¯è§ï¼Œåº”è¯¥**æš‚åœ**ã€‚
-   **`AppLifecycleState.resumed`**ï¼šå½“åº”ç”¨é‡æ–°å›åˆ°å‰å°æ—¶è§¦å‘ã€‚æ­¤æ—¶åº”ç”¨æ¢å¤å¯è§ï¼Œåº”è¯¥**æ¢å¤**ã€‚

`AppPauseProvider` è´Ÿè´£åœ¨åº”ç”¨è¿›å…¥åå°æ—¶å‘å‡ºæš‚åœä¿¡å·ã€‚

### 3. TickerMode (`TickerModePauseProvider`)

è¿™æ˜¯æœ¬æ–‡çš„é‡ç‚¹ã€‚`TickerMode` æ˜¯ Flutter åŠ¨ç”»ç³»ç»Ÿä¸­çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼Œå®ƒåŒæ ·å¯ä»¥ç”¨æ¥åˆ¤æ–­ Widget çš„å¯è§æ€§ã€‚

---

## ä¸‰ã€é‡ç‚¹ï¼šä¸ºä»€ä¹ˆ TickerMode å¯ä»¥åˆ¤æ–­å¯è§æ€§ï¼Ÿ

### ä»€ä¹ˆæ˜¯ Tickerï¼Ÿ

`Ticker` æ˜¯ Flutter åŠ¨ç”»çš„â€œå¿ƒè·³â€ï¼Œå®ƒä»¥å±å¹•çš„åˆ·æ–°ç‡ï¼ˆé€šå¸¸æ˜¯ 60fpsï¼‰ä¸ºèŠ‚å¥ï¼Œå‘¨æœŸæ€§åœ°è§¦å‘å›è°ƒã€‚`AnimationController` ç­‰åŠ¨ç”»æ§åˆ¶å™¨å°±æ˜¯ä¾èµ– `Ticker` æ¥é©±åŠ¨åŠ¨ç”»å€¼çš„å˜åŒ–ã€‚

### ä»€ä¹ˆæ˜¯ TickerModeï¼Ÿ

`TickerMode` æ˜¯ä¸€ä¸ª `InheritedWidget`ï¼Œå®ƒå…è®¸ä½ æ˜¾å¼åœ°**å¯ç”¨æˆ–ç¦ç”¨**å…¶å­æ ‘ä¸­æ‰€æœ‰ `Ticker` çš„æ´»åŠ¨ã€‚

```dart
TickerMode(
  enabled: true, // or false
  child: MyAnimatedWidget(),
);
```

-   å½“ `enabled` ä¸º `true` æ—¶ï¼Œå­æ ‘ä¸­çš„ `Ticker` å¯ä»¥æ­£å¸¸â€œå¿ƒè·³â€ï¼ŒåŠ¨ç”»ä¼šæ’­æ”¾ã€‚
-   å½“ `enabled` ä¸º `false` æ—¶ï¼Œå­æ ‘ä¸­çš„ `Ticker` ä¼šè¢«â€œé™éŸ³â€ï¼ˆmutedï¼‰ï¼Œå¿ƒè·³åœæ­¢ï¼Œæ‰€æœ‰åŠ¨ç”»éƒ½ä¼šæš‚åœã€‚

### TickerMode ä¸å¯è§æ€§çš„å…³ç³»

åœ¨ `TabBarView` æˆ– `PageView` è¿™ç±»åœºæ™¯ä¸­ï¼Œä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œå¼€å‘è€…éœ€è¦æ‰‹åŠ¨ä½¿ç”¨ `TickerMode` æ¥åŒ…è£¹éå½“å‰æ˜¾ç¤ºçš„é¡µé¢ï¼Œä»¥æš‚åœå®ƒä»¬çš„åŠ¨ç”»è¡Œä¸ºã€‚

å½“ä½ æ»‘åŠ¨ `TabBarView` æ—¶ï¼Œå®ƒå†…éƒ¨ä¼šåšè¿™æ ·çš„äº‹æƒ…ï¼š

-   å¯¹äº**å½“å‰å¯è§çš„ Tab**ï¼Œå®ƒä¼šç”¨ `TickerMode(enabled: true, ...)` åŒ…è£¹ã€‚
-   å¯¹äº**å…¶ä»–ä¸å¯è§çš„ Tab**ï¼Œå®ƒä¼šç”¨ `TickerMode(enabled: false, ...)` åŒ…è£¹ã€‚

è¿™æ ·ä¸€æ¥ï¼Œä¸å¯è§ Tab ä¸­çš„æ‰€æœ‰åŠ¨ç”»ï¼ˆå¦‚ `AnimationController`ã€`ListView` çš„æ»šåŠ¨åŠ¨ç”»ç­‰ï¼‰éƒ½ä¼šè‡ªåŠ¨æš‚åœï¼Œä»è€ŒèŠ‚çœäº†å¤§é‡çš„æ€§èƒ½å¼€é”€ã€‚

**ç»“è®º**ï¼š`TickerMode.of(context)` çš„ `enabled` çŠ¶æ€ï¼Œæˆä¸ºäº†ä¸€ä¸ªåˆ¤æ–­å½“å‰ Widget æ˜¯å¦åœ¨ `TabBarView` è¿™ç±»ç»„ä»¶ä¸­â€œå¯è§â€çš„ç»ä½³æŒ‡æ ‡ã€‚

`TickerModePauseProvider` æ­£æ˜¯åˆ©ç”¨äº†è¿™ä¸€ç‚¹ï¼šå®ƒä¼šç›‘å¬ `TickerMode.getNotifier(context)`ï¼Œå½“ `TickerMode` è¢«ç¦ç”¨æ—¶ï¼Œå®ƒå°±ä¼šå‘å‡ºæš‚åœä¿¡å·ã€‚

---

## å››ã€ViewModel çš„æ··åˆåˆ¤æ–­æœºåˆ¶ä¸è‡ªå®šä¹‰ Pause

### æ··åˆåˆ¤æ–­æœºåˆ¶ (`PauseAwareController`)

`view_model` çš„å¼ºå¤§ä¹‹å¤„åœ¨äºï¼Œå®ƒä¸ä¾èµ–äºä»»ä½•å•ä¸€çš„å¯è§æ€§åˆ¤æ–­ï¼Œè€Œæ˜¯å°†ä¸Šè¿°æ‰€æœ‰æœºåˆ¶ç»„åˆåœ¨äº†ä¸€èµ·ã€‚

`ViewModelStateMixin` ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª `PauseAwareController`ï¼Œå¹¶ä¸ºå…¶æ³¨å…¥å¤šä¸ª `ViewModelBindingPauseProvider`ï¼š

```dart
late final _pauseAwareController = PauseAwareController(
  providers: [
    _appPauseProvider,          // åº”ç”¨åˆ‡åå°æ—¶æš‚åœ
    _routePauseProvider,        // è·¯ç”±è¢«è¦†ç›–æ—¶æš‚åœ
    _tickerModePauseProvider,   // TickerMode = false æ—¶æš‚åœ
  ],
  // ...
);
```

`PauseAwareController` çš„æ ¸å¿ƒé€»è¾‘éå¸¸æ¸…æ™°ï¼š

> **åªè¦æœ‰ä»»æ„ä¸€ä¸ª `provider` è¦æ±‚æš‚åœï¼Œ`ViewModel` å°±ä¼šè¿›å…¥æš‚åœçŠ¶æ€ã€‚**

```dart
// PauseAwareController å†…éƒ¨é€»è¾‘
final newPauseState = _providerPauseStates.values.any((isPaused) => isPaused);
```

è¿™æ„å‘³ç€ï¼Œæ— è®ºæ˜¯å› ä¸ºé¡µé¢è¢«è¦†ç›–ã€åº”ç”¨åˆ‡åˆ°åå°ï¼Œè¿˜æ˜¯å› ä¸ºæ‰€åœ¨çš„ Tab å˜æˆäº†éå½“å‰é¡¹ï¼Œ`ViewModel` éƒ½èƒ½å‡†ç¡®åœ°æš‚åœ `setState()` çš„æ‰§è¡Œã€‚

### å·¥ä½œæµç¨‹

1.  **è¿›å…¥æš‚åœ**ï¼š
    -   æŸä¸ª `ViewModelBindingPauseProvider`ï¼ˆå¦‚ `PageRoutePauseProvider`ï¼‰å‘å‡º `true`ï¼ˆæš‚åœï¼‰ä¿¡å·ã€‚
    -   `PauseAwareController` æ£€æµ‹åˆ°åï¼Œå°† `ViewModel` æ ‡è®°ä¸º `isPaused = true`ã€‚
    -   æ­¤åï¼Œå³ä½¿ `ViewModel` è°ƒç”¨ `notifyListeners()`ï¼Œ`ViewModelAttacher` ä¹Ÿä¼šæ‹¦æˆª `setState()`ï¼Œå¹¶æ ‡è®° `hasMissedUpdates = true`ã€‚UI ä¸ä¼šé‡å»ºã€‚

2.  **æ¢å¤è¿è¡Œ**ï¼š
    -   æ‰€æœ‰ `ViewModelBindingPauseProvider` éƒ½å‘å‡ºäº† `false`ï¼ˆæ¢å¤ï¼‰ä¿¡å·ã€‚
    -   `PauseAwareController` æ£€æµ‹åˆ°åï¼Œå°† `ViewModel` æ ‡è®°ä¸º `isPaused = false`ï¼Œå¹¶è§¦å‘ `onResume` å›è°ƒã€‚
    -   `ViewModelAttacher` åœ¨ `onResume` å›è°ƒä¸­æ£€æŸ¥åˆ° `hasMissedUpdates` ä¸º `true`ï¼Œäºæ˜¯æ‰§è¡Œä¸€æ¬¡ `setState()`ï¼Œå°†æ‰€æœ‰è¢«â€œæš‚åœâ€æœŸé—´çš„æ›´æ–°ä¸€æ¬¡æ€§åº”ç”¨åˆ° UI ä¸Šã€‚

### è‡ªå®šä¹‰ ViewModelBindingPauseProvider

`PauseAwareController` çš„è®¾è®¡æ˜¯å®Œå…¨å¼€æ”¾çš„ã€‚ä½ å¯ä»¥å®ç°è‡ªå·±çš„ `ViewModelBindingPauseProvider` æ¥åº”å¯¹ä»»ä½•ç‰¹æ®Šçš„æš‚åœé€»è¾‘ã€‚

ä¾‹å¦‚ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª `ConnectionPauseProvider`ï¼Œåœ¨ç½‘ç»œæ–­å¼€æ—¶æš‚åœæ‰€æœ‰ä¾èµ–ç½‘ç»œçš„ `ViewModel`ã€‚

**æ­¥éª¤**ï¼š

1.  **åˆ›å»ºè‡ªå®šä¹‰ Provider**ï¼š
    ```dart
    class ConnectionPauseProvider with ViewModelBindingPauseProvider {
      ConnectionPauseProvider() {
        Connectivity().onConnectivityChanged.listen((status) {
          if (status == ConnectivityResult.none) {
            pause(); // ç½‘ç»œæ–­å¼€ï¼Œè¯·æ±‚æš‚åœ
          } else {
            resume(); // ç½‘ç»œæ¢å¤ï¼Œè¯·æ±‚æ¢å¤
          }
        });
      }
    }
    ```

2.  **æ·»åŠ åˆ° ViewModel**ï¼š
    ä½ å¯ä»¥é€šè¿‡ `ViewModelStateMixin` çš„ `addPauseProvider` æ–¹æ³•ï¼Œåœ¨ `initState` ä¸­åŠ¨æ€æ·»åŠ ä½ çš„è‡ªå®šä¹‰ Providerã€‚

    ```dart
    class _MyPageState extends State<MyPage> with ViewModelStateMixin<MyPage> {
      @override
      void initState() {
        super.initState();
        // æ·»åŠ è‡ªå®šä¹‰çš„æš‚åœé€»è¾‘
        addPauseProvider(ConnectionPauseProvider());
      }
      // ...
    }
    ```

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥å°†ä»»ä½•ä¸šåŠ¡é€»è¾‘è½¬åŒ–ä¸º `ViewModel` çš„æš‚åœ/æ¢å¤æ¡ä»¶ï¼Œå®ç°é«˜åº¦çµæ´»å’Œç²¾-ç»†åŒ–çš„æ€§èƒ½ç®¡ç†ã€‚

---

## æ€»ç»“ä¸æ¨è

`view_model` çš„ `Pause` æœºåˆ¶æä¾›äº†ä¸€å¥—å¼ºå¤§è€Œçµæ´»çš„è§£å†³æ–¹æ¡ˆ
ï¼Œå¦‚æœä½ æ­£åœ¨å¯»æ‰¾ä¸€ä¸ªèƒ½å¤Ÿæ™ºèƒ½ç®¡ç† Widget ç”Ÿå‘½å‘¨æœŸã€ä¼˜åŒ–æ€§èƒ½å¹¶ä¿æŒä»£ç æ•´æ´çš„çŠ¶æ€ç®¡ç†æ¡†æ¶ï¼š

**ç«‹å³ä½“éªŒ**ï¼š[pub.dev/packages/view_model](https://pub.dev/packages/view_model) ğŸš€

